#!/usr/bin/with-contenv bash
# shellcheck shell=bash
# Copyright (c) 2020, MrDoob
# All rights reserved.
function log() {
echo "[Uploader] ${1}"
}
function rclone() {
rclone=/config/rclone-docker.conf
if [ ! -f ${rclone} ]; then
  log "-> Copying rclone.conf <-"
      cp /config/rclone.conf /config/rclone-docker.conf
      sed -i "s#/opt/appdata/plexguide/.blitzkeys/#/config/keys/#g" /config/rclone-docker.conf
      sed -i "s#/opt/appdata/uploader/#/config/keys/#g" /config/rclone-docker.conf
      sed -i "s#/opt/appdata/services/uploader/keys/#/config/keys/#g" /config/rclone-docker.conf
      sed -i "s#/opt/uploader/keys/#/config/keys/#g" /config/rclone-docker.conf
  log "-> Make needed edits to rclone conf <-"
else
  log "-> rclone.conf exist <-"
fi
}
function rcloneinstall() {
if [[ ! -f "/usr/bin/rclone" ]]; then
  log "-> install rclone || start <-"
      wget https://downloads.rclone.org/rclone-current-linux-amd64.zip -O rclone.zip >/dev/null 2>&1 && \
      unzip -qq rclone.zip && rm rclone.zip && \
      mv rclone*/rclone /usr/bin && rm -rf rclone* 
      rcstored=$(rclone --version | awk '{print $2}' | head -n 1)
  log "-> install rclone || done <-"
  log "-> installed rclone version ${rcstored}"
else
  rcstored=$(rclone --version | awk '{print $2}' | head -n 1)
  log "-> rclone is current installed <-"
  log "-> currently installed rclone version ${rcstored}"
fi
}

rclone
rcloneinstall
